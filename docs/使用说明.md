# 使用说明

## 环境要求

- Python 3.8+
- MySQL 5.7+
- 操作系统: Linux/macOS/Windows

## 安装步骤

### 1. 克隆项目

```bash
git clone https://github.com/aidingjing/cross-section-data-processing.git
cd cross-section-data-processing
```

### 2. 安装依赖

```bash
pip install -r requirements.txt
```

### 3. 配置

复制配置示例文件:

```bash
cp config/config.example.json config/config.json
```

编辑 `config/config.json`，填入您的配置信息:

```json
{
  "database": {
    "host": "your_database_host",
    "port": 3306,
    "user": "your_username",
    "password": "your_password",
    "database": "your_database_name",
    "charset": "utf8mb4"
  },
  "shapefiles": {
    "h_point": "data/shapefiles/横断面点.shp",
    "h_line": "data/shapefiles/横断面线.shp",
    "v_point": "data/shapefiles/纵断面点.shp",
    "v_line": "data/shapefiles/纵断面线.shp",
    "prevention_area": "data/shapefiles/防治对象分布面_合并.shp"
  }
}
```

### 4. 准备数据

将Shapefile文件放到 `data/shapefiles/` 目录:

- 横断面点.shp (及 .dbf, .shx等配套文件)
- 横断面线.shp
- 纵断面点.shp  
- 纵断面线.shp
- 防治对象分布面_合并.shp

## 使用方法

### 方式1: 执行完整流程

```bash
python scripts/main.py --all
```

### 方式2: 分步执行

```bash
# 步骤1: 数据导入
python scripts/step1_import_data.py

# 步骤2: 空间分析
python scripts/step2_spatial_analysis.py

# 步骤3: 更新adcd字段
python scripts/step3_update_adcd.py

# 步骤4: 生成编码
python scripts/step4_generate_codes.py
```

### 验证配置

```bash
python scripts/main.py --validate-config
```

## 输出说明

### 日志文件

位置: `data/output/logs/app.log`

包含详细的执行日志，包括:
- 每个步骤的开始和结束
- 处理进度
- 错误信息

### 映射文件

位置: `data/output/mappings/`

- `h_to_v_mapping.json`: 横断面与纵断面的关联关系
- `h_to_prevention_mapping.json`: 横断面与防治对象的关联关系
- `v_to_prevention_mapping.json`: 纵断面与防治对象的关联关系

格式示例:

```json
{
  "AJF110071kC00000ZBCS004": ["AJF110081kCG0000ZACS021"],
  "AJF110071kC00000ZBCS003": ["AJF110081kCG0000ZACS021"]
}
```

### 数据库表

执行完成后，以下表将被填充:

1. **IA_M_HSURFACE** - 横断面表
   - hecd: 横断面编码
   - number: 横断面编号
   - adcd: 防治对象代码
   - vecd: 关联的纵断面编码

2. **IA_M_HSPOINT** - 横断面点表
   - hecd: 横断面编码
   - 点坐标和高程等信息

3. **IA_M_VSURFACE** - 纵断面表
   - vecd: 纵断面编码
   - number: 纵断面编号
   - adcd: 防治对象代码

4. **IA_M_VSPOINT** - 纵断面点表
   - vecd: 纵断面编码
   - 点坐标和高程等信息

5. **TZX_ONLY_CODE** - 唯一代码表
   - CODE: 5位唯一代码

## 常见问题

### Q1: 数据库连接失败

**错误**: `pymysql.err.OperationalError: (2003, "Can't connect to MySQL server...")`

**解决方法**:
1. 检查数据库连接信息是否正确
2. 确保数据库服务正在运行
3. 检查防火墙设置

### Q2: Shapefile读取失败

**错误**: `FileNotFoundError: xxx.shp not found`

**解决方法**:
1. 确保Shapefile文件存在于 `data/shapefiles/` 目录
2. 确保配套文件(.dbf, .shx, .prj等)都存在
3. 检查文件路径配置是否正确

### Q3: 编码格式问题

**错误**: `UnicodeDecodeError`

**解决方法**:
1. 确保Shapefile使用UTF-8编码
2. 检查 .cpg 文件是否存在并包含正确的编码声明

### Q4: 内存不足

**错误**: `MemoryError`

**解决方法**:
1. 减小批处理大小 (config.json中的 `batch.size`)
2. 增加系统内存
3. 分批处理数据

## 性能优化建议

1. **批处理大小**: 根据数据量调整 `batch.size` (推荐: 1000-5000)
2. **提交间隔**: 调整 `commit_interval` 以平衡性能和安全性
3. **数据库索引**: 确保number字段有索引

## 数据要求

### Shapefile字段要求

**横断面点**:
- hecd, pcode, cdistance, ele, lgtd, lttd, coeff, orderNo
- 名称, 编号, 河流名, 类别

**横断面线**:
- NAME, NUMBER

**纵断面点**:
- vecd, pname, cdistance, bele, lgtd, lttd, orderNo  
- 名称, 编号, 河流名, 类别

**纵断面线**:
- NAME, NUMBER

**防治对象面**:
- 代码, 名称

## 技术支持

如遇到问题，请:
1. 查看日志文件获取详细错误信息
2. 在GitHub项目页面提交Issue
3. 附上错误日志和配置信息(脱敏后)
